---
import MSPALayout from '../../../layouts/MSPALayout.astro';
import { chapters, getChapter } from '../../../content.js';
import { getPageTitle, getImageSrc, getNextPage } from '../../../utils/pageUtils';
import PageTitle from '../../../components/PageTitle.astro';
import PageImage from '../../../components/PageImage.astro';
import PageNarration from '../../../components/PageNarration.astro';
import DialogueBox from '../../../components/DialogueBox.astro';
import NavigationCommand from '../../../components/NavigationCommand.astro';
import UtilityLinks from '../../../components/UtilityLinks.astro';

export function getStaticPaths() {
  const paths = [];
  for (const c of chapters) {
    for (let p = 1; p <= c.totalPages; p++) {
      paths.push({ params: { id: String(c.id), page: String(p) } });
    }
  }
  return paths;
}

const params = Astro.params || {};
const id = params.id;
const page = params.page;
let chapter;
try {
  chapter = getChapter(id);
} catch (e) {
  return Astro.redirect('/map');
}
const currentPage = Number(page);
const nextPage = getNextPage(chapter, currentPage);

// Preload next image for better performance
const nextImgSrc = nextPage ? getImageSrc(nextPage) : null;

// Get page title for the layout using centralized utility
const pageTitle = getPageTitle(chapter, currentPage);
---
<MSPALayout title={pageTitle}>
  {nextImgSrc && <link slot="head" rel="preload" as="image" href={nextImgSrc} />}

  <article id="reader-root" class="reader" data-chapter={chapter.id} data-total={chapter.totalPages} data-page={currentPage}>
    <PageTitle chapter={chapter} page={currentPage} />
    
    <PageImage page={currentPage} title={pageTitle} />
    
    <PageNarration chapter={chapter} page={currentPage} />
    
    <DialogueBox chapter={chapter} page={currentPage} />
    
    <NavigationCommand chapter={chapter} currentPage={currentPage} />
    
    <UtilityLinks />
  </article>

  <script src="/js/reader.js" defer></script>
</MSPALayout>